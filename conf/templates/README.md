### Upstreamr templates

Our templates are based on Jinja2 [templates](http://jinja.pocoo.org/docs/dev/templates/)

Right now due to a limitation in Upstreamr itself it only handles one template at a time, we provide you with both the templates we use for nginx.

#### nginx_upstream.template

This template is our current Nginx Upstream definitions template, we normally drop the results of this template in `/etc/nginx/upstreamr.d`

We consume all information from the table ConfigLBUpstreams that is in DynamoDB generated by Environment Manager, we plan to migrate this to Environment Manager API calls in the next release.

#### nginx_service.template

This template is our current Nginx Services (Virtual Hosts) definitions template, we normally drop the results of this template in `/etc/nginx/services.d`

We consume all information from the table ConfigLBServices that is in DynamoDB generated by Environment Manager, we plan to migrate this to Environment Manager API calls in the next release.

The Jinja2 template supplied takes in a dictionary called ‘Data’ which should equal the Value field in an Environment Manager LB Setting. The template then lays out a standard Nginx ‘server’ code block, starting with the listen directive and SSL cert and keys (if required) followed by the server_name directive (which could be zero or more entries) for hostname-based processing. Following this the Locations array is processed. Each location is considered in turn, with the location directive utilizing standard matching for ‘/’ or ‘= /’ paths, and case insensitive regex matching for all others. Should you wish these to be standard matching locations instead simply remove the ~* characters from line 32. In each location, should an If Condition be present, the condition is stated in the nginx config, and those directives that are allowed to live inside an If block are laid out (see Nginx documentation for directive scope in this case). Should an If Condition not be present, all variables are laid out into the location, as shown in lines 61-99.

Some points to note (in processing order):

* This template assumes port 80 for HTTP connections and port 443 for SSL, purely for simplicity. If you wish other ports you will need to edit.
* If an SSLCertificate is present in your config, but an SSLKey is null, this will render but result in an nginx reload error
* The rendering order matches the entry order of Locations in the Environments Manager JSON template, top to bottom. Should you wish to order them differently (such as longest to shortest), you will need to sort the array in the template first.
* Locations with the same path are combined into one location, and it is assumed that none should have both the same path AND the same If Condition. If this occurs it will result in an error. Similarly, if a location contains an If Condition, and is the only location of that path, this may not render necessary directives in some situations, and also result in an error.
